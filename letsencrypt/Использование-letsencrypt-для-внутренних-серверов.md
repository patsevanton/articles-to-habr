Использование Let's Encrypt для внутренних серверов
Let's Encrypt - это революционно новый центр сертификации, который предоставляет бесплатные сертификаты в полностью автоматизированном процессе. Эти сертификаты выдаются по протоколу ACME. За последние два года в Интернете широко использовалась технология Let’s Encrypt - более 50% веб-сертификатов SSL / TLS теперь выдает Let’s Encrypt.
Хотя и существует множество инструментов для автоматического обновления сертификатов для общедоступных веб-серверов (certbot, simp_le, я писал о том, как это сделать 3 года назад), трудно найти какую-либо полезную информацию о том, как выдавать сертификаты для внутренних серверов, не подключенных к Интернету, и / или устройства с Let's Encrypt.
В этом блоге описывается, как выдавать сертификаты Let's Encrypt для внутренних серверов. В Datto мы выдали сертификат на каждую из наших 65 000 90 000+ устройств BCDR, использующих именно этот механизм.

Содержание
1. Как это работает?
2. Пример: внутренний сервер 10.1.1.4, он же. xi8qz.example.com
2.1. Предварительные требования: назначение домена для каждой машины (шаги 1-3)
2.2. Запрос сертификата (шаги 4-14)
3. Рекомендации по развертыванию: ограничения скорости Let's Encrypt.

Hello Hacker News, впервые на главной странице HN! Для меня это большая честь! Я ответил на все вопросы в разделе комментариев.
Если вы ищете реализацию этой идеи, вам может быть интересен localtls. Я сам не тестировал, но похоже, что он делает то же самое, что я здесь описываю.

1. Как это работает?
Чтобы выпустить сертификат с помощью Let's Encrypt, вы должны доказать, что вы либо являетесь владельцем веб-сайта, для которого хотите выпустить сертификат, либо владеете доменом, на котором он работает. Обычно автоматизированные инструменты, такие как certbot, используют HTTP-запрос для подтверждения права собственности на сайт с использованием хорошо известного каталога. Хотя это прекрасно работает, если сайт подключен к Интернету (и Let's Encrypt может проверять файлы HTTP-запросов с помощью простого HTTP-запроса), он не работает, если ваш сервер работает на 10.1.1.4 или на любом другом внутреннем адресе.
Задача DNS решает эту проблему, позволяя подтвердить право собственности на домен с помощью TXT-записи DNS _acme-challenge.example.com. Let's Encrypt проверит, что запись соответствует ожидаемому, и выдаст ваш сертификат, если все сложится.
Итак, действительно волшебными ингредиентами для выдачи сертификатов для внутренних компьютеров, не подключенных к Интернету, являются:
Выделенная зона DNS для всех ваших внутренних устройств, например xi8qz.example.com и динамический DNS-сервер для управления этой зоной (здесь: example.com)
Клиент ACME, способный использовать DNS-запрос Let's Encrypt для подтверждения права собственности на домен.

2. Пример: внутренний сервер 10.1.1.4, он же. xi8qz.example.com
На следующей диаграмме показано, как мы реализовали интеграцию Let's Encrypt для наших устройств резервного копирования Datto. Каждое устройство (читайте: внутренний сервер) находится за NAT и имеет собственный локальный IP-адрес.
Общий подход прост: устройство регулярно обращается к нашему серверу управления, чтобы обеспечить доступ к нему через его собственный поддомен. Если его локальный IP-адрес изменяется, он запускает обновление своего собственного поддомена. Кроме того, он регулярно проверяет, действителен ли сертификат, и запрашивает обновление, если он устарел.
Вот немного подробностей об этом процессе:
Internal server (ip:10.1.1.4, id:xi8qz)	Внутренний сервер (ip: 10.1.1.4, id: xi8qz)
Control server	Сервер управления
DDNS server (owns example.com)	DDNS-сервер (владеет example.com)
Let's Encrypt ACME	Let's Encrypt ACME
1. If local IP address has changed (check and repeat regularly)	1. Если локальный IP-адрес изменился (проверяйте и повторяйте регулярно)
4. if renewal needed, generate CSR for xi8qz.example.com	4. Если необходимо продление, сгенерируйте CSR для xi8qz.example.com
5. Request renewal with CSR for xi8qz.example.com	5. Запросите продление с CSR для xi8qz.example.com
2. Update DNS record for xi8qz.example.com with 10.1.1.4	2. Обновите запись DNS для xi8qz.example.com с 10.1.1.4.
14. Certificate (and chain)	14. Сертификат (и цепочка)
3. Set A record for xi8qz.example.com to 10.1.1.4	3. Установите запись A для xi8qz.example.com на 10.1.1.4.
xi8qz.example.com now resolves to 10.1.1.4	xi8qz.example.com теперь разрешается до 10.1.1.4
8. Set TXT record for acme challenge.xi8qz.example.com	8. Установите запись TXT для acme challenge.xi8qz.example.com.
11. Check if challenge has been veified (repeat until successful)	11. Убедитесь, что вызов был подтвержден (повторяйте до успешного завершения).
12. Request certificate with CSR (new-cert)	12. Запросить сертификат с CSR (new-cert)
13. Certificate (and chain)	13. Сертификат (и цепочка)
10. Verify challenge	10. Подтвердите вызов
6. Request DNS challenge for xi8qz.example.com (new-aithz)	6. Запросить DNS-запрос для xi8qz.example.com (new-aithz)
7. DNS challenge URL and token	7. URL запроса DNS и токен
9. Notify challenge has been placed (challenge)	9. Уведомить о размещении вызова (вызов)


В этом примере предположим, что мы пытаемся выпустить сертификат для устройства с идентификатором xi8qz и локальным IP-адресом 10.1.1.4. С точки зрения этого устройства необходимо сделать два запроса:
Шаги 1-3: Во-первых, ему необходимо установить / обновить свой собственный DNS-домен (здесь: xi8qz.example.com). Этот домен позже будет использоваться в сертификате как общее имя (CN). Кроме того, необходимо убедиться, что эта запись обновляется каждый раз при изменении IP-адреса сервера.
Шаги 4-14: необходимо регулярно проверять, нужно ли обновлять локальный сертификат, и запрашивать обновление, если пришло время. Очевидно, что если сертификата нет, его нужно «обновить».
Давайте теперь рассмотрим эти шаги более подробно.

2.1. Предварительные требования: назначение домена для каждой машины (шаги 1-3)
Как упоминалось выше, нам нужно дать каждому устройству правильное доменное имя, чтобы иметь возможность подтвердить право собственности на Let's Encrypt, поэтому нам нужно купить домен (здесь: example.com) и делегировать его NS-записи нашему серверу DDNS:

Вдобавок к этому нам нужна возможность динамически добавлять и удалять записи из него (через какой-то API). Я ранее писал о том, как развернуть собственный DDNS-сервер, если вам интересно.
После того, как все это настроено, нам нужно убедиться, что запись A машины обновляется при изменении ее IP-адреса. Для нашей внутренней машины давайте назначим xi8qz.example.com в качестве домена. Если все работает правильно, вы сможете разрешить этот домен по его IP-адресу, используя обычный DNS-запрос:

2.2. Запрос сертификата (шаги 4-14)
Предполагая, что теперь вы полностью контролируете зону DNS для example.com и можете быстро редактировать ее динамически, у вас все готово для фактической выдачи сертификатов для вашего локального домена устройства через Let's Encrypt.
В нашем примере устройства оно будет регулярно проверять, действителен ли существующий сертификат (шаг 4). Если сертификата нет или срок действия существующего скоро истечет, устройство сгенерирует пару ключей и запрос на подпись сертификата (CSR), используя назначенное ему имя хоста (здесь: xi8qz.example.com) в качестве CN, и оно отправит этот CSR на управляющий сервер (шаг 5).
После авторизации запроса (важный шаг, не показанный на схеме!), Управляющий сервер запрашивает DNS-запрос для данного домена из ACME API через вызов Pre-Authorization / new-authz API (шаг 6). ACME API отвечает запросом DNS (шаг 7). Если все идет хорошо, это выглядит примерно так:

Используя этот ответ, управляющий сервер должен установить запись DNS TXT на _acme-challenge.xi8qz.example.com (шаг 8) и уведомить ACME API о том, что ответ на запрос был размещен (шаг 9).
После того, как ответ на запрос был проверен с помощью Let's Encrypt (шаг 10-11), сертификат можно, наконец, запросить с помощью CSR (шаг 12-13).
После того, как Let's Encrypt ответит сертификатом, вы увидите на проводе что-то вроде этого:

Если декодировать с помощью openssl, мы увидим, что это настоящая сделка:

Этот сертификат затем возвращается в машину (шаг 14). После перезапуска веб-сервера устройства / сервера к его веб-интерфейсу можно будет получить доступ через HTTPS в браузере или из командной строки:

3. Рекомендации по развертыванию: ограничения скорости Let's Encrypt.
Важно отметить, что если вы планируете реализовать этот механизм для большого количества серверов, вы используете промежуточные среды Let's Encrypt для тестирования и, что более важно, учитываете ограничения их скорости.
По умолчанию Let's Encrypt позволяет выдавать только 20 сертификатов в неделю для одного и того же домена или одной и той же учетной записи. Чтобы увеличить это число, вы должны либо запросить более высокий предел скорости, либо добавить свой домен в список общедоступных суффиксов (обратите внимание: добавление вашего домена здесь имеет другие последствия!).
Из-за этих ограничений скорости жизненно важно, чтобы вы распределили начальное развертывание настолько, чтобы оставаться ниже ограничения скорости, и чтобы вы оставили достаточно места для добавления будущих серверов. Также рассмотрите возможность продления в первоначальном плане развертывания.

4. Резюме
Как видите, это не так уж и сложно.
Сначала мы присвоили каждому устройству (так называемому внутреннему серверу) публичное доменное имя, используя наш собственный динамический DNS-сервер и выделенную зону DNS. Используя домен, назначенный серверу (здесь: xi8qz.example.com), мы затем использовали предложение бесплатного сертификата Let's Encrypt и их запрос DNS, чтобы выпустить сертификат для этого сервера.
Сделав это для всех внутренних серверов, мы можем обеспечить безопасную связь в нашей внутренней ИТ-инфраструктуре без необходимости развертывания настраиваемого сертификата CA или необходимости платить за сертификаты.

Lincoln DeCoursey 27 ноября 2018 г.
Спасибо за информативную статью. В Интернете ходила шутка: «Откуда вы знаете, что собираетесь войти в часть критически важной инфраструктуры», и ответом было «предупреждение о недопустимом сертификате в вашем браузере». Как вы указываете, ACME - это решение для автоматизации генерации и развертывания сертификатов, особенно внутри из локального ЦС, но использование вами LE здесь (общедоступного, а не внутреннего ЦС) интересно, поскольку оно устраняет то, что могло бы быть проблемой. о распределении доверия для внутреннего центра сертификации, тем более, что многие из ваших конечных пользователей могут быть внешними партнерами. Тем не менее, я думаю, что во многих организациях основным соображением при выборе внутреннего центра сертификации для внутренней инфраструктуры является предпочтение использования внутренних зон DNS для внутреннего сетевого пространства в отличие от DNS с разделенным горизонтом, что имеет свои собственные последствия. считается. Еще раз спасибо за отличное описание!

Александр Георгиев 18 декабря 2018 г.
Но он показывает внутреннюю информацию, такую ​​как соглашение об именах, диапазоны IP-адресов и т. Д.
См., Например, http://pdns.daloo.de/search.php?alike=1&q=datto
Привет из старого доброго Франкфурта

Филипп К. Хекель 18 декабря 2018 г.
Ха. Привет! Это действительно так, есть идея получше?

Кроме того, нет схемы именования (она случайная), а внутренние IP-адреса из десятков тысяч разных сетей, так что все они 10.x и 192.168.x ... Я все слышу, если у вас есть лучший идея.


Александр Георгиев 4 января 2019 г.
«Кто-то» должен решить, подходит ли раскрытие этой информации, или им больше подходит запуск собственного центра сертификации (с дополнительной работой). Думаю, придется учесть множество факторов. Я не принимаю таких решений :)


Джеймс Хорсли 1 марта 2019 г.
Я полагаю, что новая поддержка сертификатов LE wild card должна снять озабоченность Александра Георгиева - один сертификат для всех машин, поэтому нет необходимости раскрывать все их данные DNS.


Филипп К. Хекель 1 марта 2019 г.
В случае моей компании мы не можем использовать групповой сертификат, потому что устройства, которые продает моя компания, принадлежат разным клиентам. Наличие только одного сертификата / ключа означало бы, что они смогут принять меры.


Роберт 10 марта 2019
Почему бы не установить для записи A для внешнего DNS-сервера что-то вроде 1.1.1.1, и внутренний DNS-сервер имеет правильный IP-адрес (или представление на том же DNS-сервере). Таким образом вы не попадете в Интернет с внутренних IP-адресов.


Филипп К. Хекель 10 марта 2019 г.
Роберт, спасибо за комментарий. Ваш подход определенно сработал бы, если бы 65 тысяч серверов находились в одной управляемой сети. Однако вариант использования, для которого мы это сделали, отличается:
Моя компания продает устройства резервного копирования, которые наши клиенты размещают в сети своей компании (так же, как если бы вы разместили маршрутизатор в своей собственной сети). Поскольку мы не контролируем ничего, кроме нашего устройства в сетях наших клиентов, мы пошли по этому пути, чтобы обеспечить безопасный веб-интерфейс для нашего устройства. А поскольку 65 тыс. Серверов / устройств (теперь больше 80 тыс.) Расположены в десятках тысяч различных сетей, утечка внутреннего IP-адреса - это совсем неплохо, особенно с учетом того, что нет возможности соотнести их с клиентом.
Для обычных «внутренних серверов» в компании я, вероятно, рекомендовал бы использовать сертификат с подстановочными знаками и внутренний DNS-сервер.


Ханс Верфер 11 марта 2019 г.
Настоящее волшебство заключается в реализации таких внутренних сертификатов с помощью Gitlab. Это кажется невозможным.


mrkunkel 12 марта 2019
Если вы используете разделенный DNS, все общедоступные DNS могут указывать на одну и ту же систему, если вы довольны распространением сертификатов на свои внутренние системы. Что относительно тривиально.


Бернд Зеймец 12 марта 2019 г.
Вы можете просто использовать безводно-обезвоженный марионеточный модуль. Конечно, для этого нужна работающая марионеточная установка….


Эрик 12 марта 2019 г.
Спасибо за подробное описание шагов, которые вы предпринимаете для всего этого. Есть ли шанс, что вы подумаете об открытии исходного кода кода / скриптов, которые вы используете для выполнения всех этих шагов?


Положения и условия 14 марта 2019 г.
Что является управляющим сервером в этом примере? Никакой информации не предоставлено.


Филипп К. Хекель 14 марта 2019 г.
Повторное разделение DNS: если вы контролируете инфраструктуру, есть масса других решений. Если вы этого не сделаете, это единственное, о чем я мог подумать. Единственное, что мы контролируем в сети наших клиентов, - это наше собственное устройство резервного копирования ...

Филипп К. Хекель 14 марта 2019 г.
Re с открытым исходным кодом: код, который выполняет эти шаги, к сожалению, является проприетарным кодом, но идея довольно проста. Вы можете использовать любой «клиент ACME» на вашем любимом языке (Google поможет вам в этом), и вы можете использовать простой DynDNS, такой как тот, который я описал в другом посте.
Вот небольшой фрагмент из конечной точки API, которую вызывают наши устройства, и я понимаю, что она не очень полезна, но показывает, что мы выполняем именно те шаги, которые я описал в статье. И это настоящий код, а не псевдокод:
$domain = $this->getVerifiedDomain($id, $csr);
$this->logger->info(‘Requesting new certificate for ‘ . $domain . ‘ …’);
$challenge = $this->acmeService->requestDnsChallenge($domain);
$this->ddnsService->set(
“_acme-challenge.$domain”,
‘TXT’,
$challenge->getDigest(),
self::CHALLENGE_RECORD_PRIORITY,
self::CHALLENGE_RECORD_TTL_SECONDS,
self::CHALLENGE_RECORD_EXPIRY_SECONDS
);
$this->time->sleep(self::CHALLENGE_PLACED_SETTLE_SECONDS);
$this->acmeService->notifyChallengePlaced($challenge);
$this->acmeService->waitForChallengeVerification($challenge);
$certificate = $this->acmeService->requestCertificate($csr);
$this->ddnsService->remove(“_acme-challenge.$domain”, ‘TXT’);
return $certificate;

Филипп К. Хекель 14 марта 2019 г.
По поводу «что такое управляющий сервер»: поскольку мы не контролируем устройства, которым нужен сертификат, мы никогда им слепо не доверяем. Управляющий сервер - единственный сервер, взаимодействующий с API Let's Encrypt.


Роберт Пенз 14 марта 2019 г.
Еще раз о разделенном DNS:
Вам не нужно контролировать больше, чем оборудование ваших клиентов
Ваш внешний DNS разрешает blabla.mydomain.com на один из ваших IP-адресов (не имеет значения, какой). Для ACME вы используете метод DNS TXT.
На вашем внутреннем DNS-сервере (сервере, который ваши системы используют для получения IP-адреса для доступа к устройствам резервного копирования) blabla.mydomain.com преобразуется в реальный IP-адрес.
Вы можете получить доступ к устройствам через их DNS-имя, но никто в Интернете не может разрешить DNS-имя и, таким образом, искать ваши устройства. Если вы используете DynDNS для устройства для обновления записи DNS, это тоже не проблема, просто обновите только внутренний DNS.
Слово «внутренний DNS» в этой погоне немного вводит в заблуждение.


Alex H 28 марта 2019
Рад видеть, что я не одинок. Я пришел к этому решению примерно в конце 2017 года, автоматизируя обновление моего внутреннего сертификата таким же образом. Поскольку сценарии разрабатывались собственными силами, мы также расширили их для применения и к другим системам, не являющимся веб-серверами, - практически ко всему, что использует SSL, включая почтовые серверы, маршрутизаторы, межсетевые экраны и многие другие продукты таких известных производителей, как Cisco и F5. Это действительно здорово, чего вы можете достичь, когда вы контролируете всю инфраструктуру, и если вы немного креативны. Отличная документация!


id_wno 28 марта 2019
Вы смотрели acme-dns (https://github.com/joohoi/acme-dns)? Я думаю, что это могло бы еще больше упростить и автоматизировать подход.


Бруно В. 28 марта 2019 г.
Большое спасибо за вашу работу. Это типичная проблема для устройств Интернета вещей, в которые встроена веб-консоль, и до тех пор я так и не нашел надежного решения.
Сейчас:
- «Внутренний сервер» находится в помещении вашего клиента.
- «Давайте зашифровать» - это настоящая публичная услуга (а не локальный экземпляр).
- DNS .example.com должен быть любой государственной службой, и вы должны платить за имя.
- DNS xx123.example.com может находиться в вашей компании или в помещении вашего клиента.
- Я не понял, настраиваете ли вы одно корневое имя x12-custom1.datto-appliance.com
- или если у всех другое имя x12.customer1.com? что дороже.
- «Сервер управления» есть в вашей компании? Не в помещении вашего клиента.

Еще раз спасибо


Бруно В. 28 марта 2019 г.
Извините, я только что узнал, глядя на http://pdns.daloo.de/search.php?alike=1&q=datto, поэтому все ваши клиенты получают доступ к something.dattolocal.net
Думаю, вы могли бы даже заполнить его случайными данными, если бы у вас уже не было много клиентов


Филипп К. Хекель 28 марта 2019 г.
Re id / wno / acme-dns: Я еще не смотрел на это. Я проверю это.


Филипп К. Хекель 28 марта 2019 г.
Ре Бруно V:

> Я не понял, настраиваете ли вы одно корневое имя x12-custom1.datto-appliance.com
Как вы уже выяснили, у нас один домен для всех клиентов. Поддомен представляет собой случайную строку.

> «Сервер управления» есть в вашей компании, верно? Не в помещении вашего клиента.
Верный. Мы единственные, кто общается с Let's Encrypt. В противном случае нам пришлось бы поделиться учетными данными LE с нашими клиентами, чего мы не хотим делать по очевидным причинам.


Уэйн 26 июля 2019
Спасибо за интересную статью. DDns достаточно легко настроить.
Какую команду вы используете, чтобы заставить certbot работать в этом сценарии, или вам нужно писать для него сценарии?


Филипп К. Хекель 26 июля 2019 г.
Я никогда не использовал certbot, поэтому, к сожалению, не могу это комментировать. Мы реализовали это сами, используя ACME API. Я хотел бы поделиться кодом, но это внутренний код компании. Вероятно, в наши дни вы можете найти хорошие библиотеки для Let's Encrypt / ACME и использовать диаграмму в статье для вызова конечных точек API по порядку.

В этой библиотеке есть все вызовы API, которые вам нужны afaik, хотя она немного устарела и почти не тестируется. Но это было бы хорошей отправной точкой: https://github.com/skoerfgen/CertLE

Извините, я ничем не могу помочь.

Поток: new-authz

Криштиану 17 октября 2019 г.
Извините за незнание, я только начинаю с такого нетворкинга ...
Я понял, как вы получаете сертификаты на технику своей компании.
Но если ваши зарегистрированные поддомены DNS указывают на внутренние адреса, как вы получите доступ к этим устройствам в сети вашего клиента?


Наккле 21 января 2020 г.
Спасибо за интересную статью! Мы пытаемся придумать, как построить что-то подобное для нашей внутренней сети. В общем, все выяснено, и мы подошли к тому моменту, когда нам нужно убедиться, что это действительно безопасно. В частности, клиенты должны иметь возможность предоставить управляющему серверу некую идентификацию для авторизации запроса.

> После авторизации запроса (важный шаг, не показанный на схеме!), Управляющий сервер запрашивает DNS-запрос для данного домена из ACME API […].

Как вы реализовали этот шаг авторизации? Для новых серверов существует ли фаза начальной загрузки, которая включает в себя развертывание какого-либо закрытого ключа?


Филипп К. Хекель 21 января 2020 г.
@Nakkle: Что-то в этом роде. Верный.


Evin 9 июля 2020 г.
Извините, но эта статья мне совсем не помогла. Она очень сбивает с толку и просто предполагает все жизненно важные шаги, необходимые для того, чтобы эта работа действительно работала, без реальных примеров от начала до конца. Я просто пытаюсь включить https с помощью шифрования на локальном сервере, не подключенном к Интернету. У меня есть домен и локальный днс сервер.


jon r 22 июля 2020
@Evin, вы можете попробовать использовать https://github.com/Corollarium/localtls

@Philipp, спасибо за отличную запись.Посмотрите на красивую реализацию FOS, о которой он, кажется, сообщил, но еще не был здесь связан.

Для людей, которые приходят сюда из поисковых систем, но не читают статью, связанный проект GitHub реализует минимальный, менее безопасный DNS-сервер с HTTP API для создания и предложения сертификатов Let's Encrypt для получения для служб, работающих с адресами .local'ish .


Филипп К. Хекель 22 июля 2020 г.
Привет, круто, я не знал, что этот проект существует. Спасибо за ссылку. Ссылка на это в посте.


Узаир Ахмед 24 сентября 2020 г.
Очень красивая статья и умное решение. То есть DNS-сервер example.com будет преобразовывать веб-адрес устройства в локальный IP-адрес в сети клиента?


Стилман 8 апреля 2021 г.
Я считаю, что следующее программное решение (собственный портал) упрощает то, что объясняется в этом руководстве:

https://github.com/RealTimeLogic/SharkTrust
